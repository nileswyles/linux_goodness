#!/bin/perl

my ($SWITCH) = @ARGV;

my $DEVICE_ID_VIDEO = "0000:01:00.0"; # video
my $DEVICE_ID_VIDEO_AUDIO = "0000:01:00.1"; # audio

my $VFIO_DRIVER_NAME = "vfio-pci";
#my $NVIDIA_DRIVER_NAME = "nvidia";
my $NVIDIA_DRIVER_NAME = "nouveau";
my $AUDIO_DRIVER_NAME = "snd_hda_intel";

sub updateDeviceToDriverLinkState {
	my ($device_id, $driver_name, $bind_state) = @_;
	my $cmd = "echo $device_id > /sys/bus/pci/drivers/$driver_name/$bind_state";
	print($cmd."\n");
	system($cmd);
}

sub printDriverState {
	print("VFIO driver: \n");
	system("ls -la /sys/bus/pci/drivers/$VFIO_DRIVER_NAME");
	print("\nNVIDIA driver: \n");
	system("ls -la /sys/bus/pci/drivers/$NVIDIA_DRIVER_NAME");
	print("\nIntel Audio driver: \n");
	system("ls -la /sys/bus/pci/drivers/$AUDIO_DRIVER_NAME");
}

print("Configuring drivers: \n");
if ($SWITCH eq "-off") {
	# unbind vfio video driver
	updateDeviceToDriverLinkState($DEVICE_ID_VIDEO, $VFIO_DRIVER_NAME, "unbind");

	# unbind vfio audio driver
	updateDeviceToDriverLinkState($DEVICE_ID_VIDEO, $VFIO_DRIVER_NAME, "unbind");
	my $CMD_UNBIND_VIDEO_AUDIO = "echo $DEVICE_ID_VIDEO_AUDIO > /sys/bus/pci/drivers/$VFIO_DRIVER_NAME/unbind";
	print($CMD_UNBIND_VIDEO_AUDIO."\n");
	system($CMD_UNBIND_VIDEO_AUDIO);

	# bind snd_hda_intel audio driver
	my $CMD_BIND_VIDEO_AUDIO = "echo $DEVICE_ID_VIDEO_AUDIO > /sys/bus/pci/drivers/$AUDIO_DRIVER_NAME/unbind";
	print($CMD_BIND_VIDEO_AUDIO."\n");
	system($CMD_BIND_VIDEO_AUDIO);

	# if nvidia kernel module not loaded, modprobe... else bind nvidia video driver.
	if (`lsmod` =~ /$NVIDIA_DRIVER_NAME.*/) { # NVIDIA MODULE LOADED
		my $CMD_BIND = "echo $DEVICE_ID_VIDEO > /sys/bus/pci/drivers/$NVIDIA_DRIVER_NAME/bind";
		print($CMD_BIND."\n");
		system($CMD_BIND);
	} else {
		#my $CMD_ENABLE_NVIDIA = "modprobe nvidia_uvm; \\\n".
		#	"modprobe nvidia_drm; \\\n". 
		#		"modprobe nvidia-modeset; \\\n".
		#		"modprobe nvidia";
		my $CMD_ENABLE_NVIDIA = "modprobe noveau";
		print($CMD_ENABLE_NVIDIA."\n");
		system($CMD_ENABLE_NVIDIA);
		print("ATTENTION! NVIDIA driver enabled... please restart the Display Manager?.\n");
	}
	print("Toggled $DEVICE_ID_VIDEO to $BIND_DRIVER_NAME\n");
	print("Toggled $DEVICE_ID_VIDEO_AUDIO to snd_hda_intel\n");
} elsif ($SWITCH eq "-on") {
	# unbind nvidia video driver
	my $CMD_UNBIND = "echo $DEVICE_ID_VIDEO > /sys/bus/pci/drivers/$NVIDIA_DRIVER_NAME/unbind";
	print($CMD_UNBIND."\n");
	system($CMD_UNBIND);

	# unbind snd_hda_intel audio driver
	my $CMD_UNBIND_VIDEO_AUDIO = "echo $DEVICE_ID_VIDEO_AUDIO > /sys/bus/pci/drivers/snd_hda_intel/unbind";
	print($CMD_UNBIND_VIDEO_AUDIO."\n");
	system($CMD_UNBIND_VIDEO_AUDIO);

	# bind VFIO audio
	my $CMD_BIND_VIDEO_AUDIO = "echo $DEVICE_ID_VIDEO_AUDIO > /sys/bus/pci/drivers/$BIND_DRIVER_NAME/bind";
	print($CMD_BIND_VIDEO_AUDIO."\n");
	system($CMD_BIND_VIDEO_AUDIO);

	# bind VFIO video
	print($CMD_BIND."\n");
	system($CMD_BIND);
	print("Toggled $DEVICE_ID_VIDEO to $BIND_DRIVER_NAME\n");
	print("Toggled $DEVICE_ID_VIDEO_AUDIO to $BIND_DRIVER_NAME\n");
} else {
	print("User did not provide a valid options, printing current state: \n\n");
}

printDriverState();
